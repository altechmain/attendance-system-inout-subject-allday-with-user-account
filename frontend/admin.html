<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Upload & Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #f4f6fb;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;   /* or 1000px, adjust as needed */
      margin: 40px auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 2.5em 2em 2em 2em;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e6ed;
      margin-bottom: 2em;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 1em 0;
      cursor: pointer;
      font-weight: 500;
      color: #6c7a89;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-bottom 0.2s;
      background: none;
      outline: none;
    }
    .tab.active {
      color: #2d5be3;
      border-bottom: 2px solid #2d5be3;
      background: #f4f6fb;
    }
    h2 {
      margin-top: 0;
      color: #2d5be3;
      font-size: 1.3em;
      letter-spacing: 0.5px;
      margin-bottom: 1.2em;
      text-align: center;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    input[type="text"], input[type="email"], input[type="file"] {
      padding: 0.8em;
      border: 1px solid #d1d9e6;
      border-radius: 6px;
      font-size: 1em;
      background: #f9fafc;
      transition: border 0.2s;
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="file"]:focus {
      border: 1.5px solid #2d5be3;
      outline: none;
      background: #fff;
    }
    button[type="submit"] {
      background: linear-gradient(90deg, #2d5be3 60%, #4f8cff 100%);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.9em 0;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(45,91,227,0.08);
    }
    button[type="submit"]:hover {
      background: linear-gradient(90deg, #1c3fa0 60%, #3576e0 100%);
    }
    .message {
      margin-top: 0.5em;
      padding: 0.7em 1em;
      border-radius: 5px;
      font-size: 0.98em;
      background: #eaf6ff;
      color: #1c3fa0;
      border: 1px solid #b5d6f8;
      min-height: 1.2em;
    }
    @media (max-width: 500px) {
      .container {
        max-width: 98vw;
        padding: 1.2em 0.5em 1.5em 0.5em;
      }
      .tabs {
        font-size: 0.98em;
      }
    }
    @media print {
      button[onclick="printReportSection()"],
      .report-pagination,
      .report-filter-caption,
      #reportSearch {
        display: none !important;
      }
      body {
        width: 8.5in !important;
        height: 13in !important;
        margin: 0;
        padding: 0;
      }
      #reportPreview {
        page-break-after: avoid;
      }
      #reportPreview .report-filter-caption,
      #reportPreview #reportSearch {
        display: none !important;
      }
    }
    #reportPreview {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 2em 1.5em 2em 1.5em;
      margin: 0 auto;
      max-width: 100%;
      width: auto;         /* Changed from 1400px to auto */
      overflow-x: auto;
    }
    @media (max-width: 1500px) {
      #reportPreview {
        width: 98vw;
        min-width: 600px;
        padding: 1em 0.5em 1.5em 0.5em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <button class="tab active" id="tab-subject">Register Subject</button>
      <button class="tab" id="tab-student">Student Management</button>
      <button class="tab" id="tab-upload">Upload CSV</button>
      <button class="tab" id="tab-report">Report</button> <!-- NEW TAB -->
    </div>

    <!-- Subject Registration -->
    <div class="tab-content" id="content-subject">
      <h2>Subject Management</h2>
      <form id="subjectForm" autocomplete="off">
        <input type="text" name="subject_code" placeholder="Subject Code" required />
        <input type="text" name="subject_description" placeholder="Subject Description" required />
        <button type="submit">Register Subject</button>
        <div class="message" id="subjectMessage"></div>
      </form>

      <h3 style="margin-top:2em;margin-bottom:0.5em;font-size:1.1em;color:#2d5be3;">Manage Subjects</h3>
      <div style="margin-bottom:1em;">
        <input
          type="text"
          id="subjectSearch"
          class="form-control"
          placeholder="Search by Subject Code or Description..."
          style="max-width:350px;display:inline-block;"
          oninput="filterSubjectTable()"
        />
      </div>
      <div style="overflow-x:auto;">
        <table id="subjectTable" style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f4f6fb;">
              <th style="border:1px solid #d1d9e6;padding:0.5em;">#</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">Subject Code</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">Description</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">Actions</th>
            </tr>
          </thead>
          <tbody id="subjectTableBody">
            <tr><td colspan="4" style="text-align:center;padding:1em;">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination controls for subject table -->
      <div id="subjectPagination" style="margin:1em 0;text-align:center;"></div>

      <!-- Edit Subject Modal -->
      <div id="editSubjectModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;align-items:center;justify-content:center;">
        <form id="editSubjectForm" style="background:#fff;padding:2em;border-radius:10px;min-width:320px;max-width:95vw;box-shadow:0 4px 24px rgba(0,0,0,0.12);display:flex;flex-direction:column;gap:1em;">
          <h3 style="margin:0 0 1em 0;color:#2d5be3;">Edit Subject</h3>
          <input type="hidden" name="id" id="edit_subject_id" />
          <input type="text" name="subject_code" id="edit_subject_code" placeholder="Subject Code" required />
          <input type="text" name="subject_description" id="edit_subject_description" placeholder="Subject Description" required />
          <div style="display:flex;gap:1em;justify-content:flex-end;">
            <button type="button" onclick="closeEditSubjectModal()" style="background:#eee;color:#333;border:none;padding:0.6em 1.2em;border-radius:5px;cursor:pointer;">Cancel</button>
            <button type="submit" style="background:#2d5be3;color:#fff;border:none;padding:0.6em 1.2em;border-radius:5px;cursor:pointer;">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Student Registration -->
    <div class="tab-content" id="content-student" style="display:none;">
      <h2>Student Registration</h2>
      <form id="studentForm" autocomplete="off">
        <input type="text" name="rfid_number" placeholder="RFID Number" />
        <input type="text" name="id_number" placeholder="Student ID Number" required />
        <input type="text" name="lastname" placeholder="Last Name" required />
        <input type="text" name="firstname" placeholder="First Name" required />
        <input type="text" name="middle_initial" placeholder="M.I." maxlength="2" />
        <input type="text" name="course" placeholder="Course" required />
        <input type="email" name="email" placeholder="Email" required />
        <button type="submit">Register Student</button>
        <div class="message" id="studentMessage"></div>
      </form>

      <h3 style="margin-top:2em;margin-bottom:0.5em;font-size:1.1em;color:#2d5be3;">Manage Students</h3>
      <div style="margin-bottom:1em;">
        <input
          type="text"
          id="studentSearch"
          class="form-control"
          placeholder="Search by Last Name, First Name, Student Number, or Course..."
          style="max-width:350px;display:inline-block;"
          oninput="filterStudentTable()"
        />
      </div>
      <div style="overflow-x:auto;">
        <table id="studentTable" style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f4f6fb;">
              <th style="border:1px solid #d1d9e6;padding:0.5em;">#</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">RFID</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">Student Number</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">Last Name</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">First Name</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">M.I.</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">Course</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">Email</th>
              <th style="border:1px solid #d1d9e6;padding:0.5em;">Actions</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <tr><td colspan="9" style="text-align:center;padding:1em;">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination controls for student table -->
      <div id="studentPagination" style="margin:1em 0;text-align:center;"></div>

      <!-- Edit Student Modal -->
      <div id="editStudentModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;display:flex;align-items:center;justify-content:center;">
        <form id="editStudentForm" style="background:#fff;padding:1.5em 1.2em;border-radius:8px;min-width:280px;max-width:370px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.12);display:flex;flex-direction:column;gap:0.7em;">
          <h3 style="margin:0 0 0.7em 0;color:#2d5be3;font-size:1.15em;">Edit Student</h3>
          <input type="hidden" id="edit_id" name="id" />
          <input type="text" id="edit_rfid_number" name="rfid_number" placeholder="RFID Number" />
          <input type="text" id="edit_id_number" name="id_number" placeholder="Student ID Number" />
          <input type="text" id="edit_lastname" name="lastname" placeholder="Last Name" />
          <input type="text" id="edit_firstname" name="firstname" placeholder="First Name" />
          <input type="text" id="edit_middle_initial" name="middle_initial" placeholder="M.I." maxlength="2" />
          <input type="text" id="edit_course" name="course" placeholder="Course" />
          <input type="email" id="edit_email" name="email" placeholder="Email" />
          <div style="display:flex;gap:0.7em;justify-content:flex-end;margin-top:0.5em;">
            <button type="button" onclick="closeEditStudentModal()" style="background:#eee;color:#333;border:none;padding:0.5em 1em;border-radius:5px;cursor:pointer;">Cancel</button>
            <button type="submit" style="background:#2d5be3;color:#fff;border:none;padding:0.5em 1em;border-radius:5px;cursor:pointer;">Save</button>
          </div>
        </form>
      </div>

      <!-- Pagination controls for student table -->
      <div id="studentPagination" style="margin-top:1em;text-align:center;"></div>
    </div>

    <!-- CSV Upload -->
    <div class="tab-content" id="content-upload" style="display:none;">
      <h2>Upload Students CSV</h2>
      <form id="uploadForm" enctype="multipart/form-data" autocomplete="off">
        <input type="file" id="csvFile" name="csv" accept=".csv" required />
        <button type="submit">Upload</button>
      </form>
      <div class="message" id="uploadMessage"></div>
    </div>

    <!-- Report Tab Content -->
    <div class="tab-content" id="content-report" style="display:none;">
      <h2>Attendance Report</h2>
      <form id="reportForm" style="display:flex; flex-direction:column; gap:1em; margin-bottom:1em;">
        <select id="reportSubject" required>
          <option value="">-- Select Subject --</option>
        </select>
        <input type="date" id="reportDate" required />
        <button type="submit" style="background:linear-gradient(90deg,#2d5be3 60%,#4f8cff 100%);color:#fff;border:none;border-radius:6px;padding:0.9em 0;font-size:1em;font-weight:600;cursor:pointer;">Preview Report</button>
      </form>
      <div id="reportPreview" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5em;">
          <div>
            <div id="reportSubjectLabel" style="font-weight:600;"></div>
            <div id="reportDateLabel" style="font-size:0.95em;color:#555;"></div>
          </div>
          <button onclick="printReportSection()" style="background:#eaf6ff;color:#1c3fa0;border:1px solid #b5d6f8;border-radius:5px;padding:0.3em 1em;cursor:pointer;">Print</button>
        </div>

        <!-- Add this caption just above the search box, inside #reportPreview -->
        <div class="report-filter-caption" style="margin-bottom:0.3em; color:#555; font-size:0.98em;">
          <em>Filter by typing any part of the student's last name, first name, student number, course, or time in/out below:</em>
        </div>
        <div style="margin-bottom:1em;">
          <input
            type="text"
            id="reportSearch"
            class="form-control"
            placeholder="Search by Last Name, Student Number, Course, Time In, or Time Out..."
            style="max-width:350px;display:inline-block;"
            oninput="filterReportTable()"
          />
        </div>

        <div style="overflow-x:auto;">
          <div id="reportTableContainer"></div>
        </div>
      </div>
    </div>
 
  </div>

  <script>
    // Add these variables at the top of your script
    let allStudents = [];
    let studentCurrentPage = 1;
    const studentRowsPerPage = 10;

    async function loadStudents() {
      const res = await fetch('http://localhost:3000/api/students');
      allStudents = await res.json();
      renderStudentTable(allStudents);
    }

    function renderStudentTable(data) {
      const tbody = document.getElementById('studentTableBody');
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:1em;">No students found.</td></tr>`;
        document.getElementById('studentPagination').innerHTML = '';
        return;
      }
      const totalRows = data.length;
      const totalPages = Math.ceil(totalRows / studentRowsPerPage);
      if (studentCurrentPage > totalPages) studentCurrentPage = totalPages || 1;
      const startIdx = (studentCurrentPage - 1) * studentRowsPerPage;
      const pageData = data.slice(startIdx, startIdx + studentRowsPerPage);

      tbody.innerHTML = pageData.map((s, idx) => `
        <tr>
          <td style="border:1px solid #d1d9e6;padding:0.5em;text-align:center;">${startIdx + idx + 1}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.rfid_number || ''}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.id_number}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.lastname}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.firstname}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.middle_initial || ''}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.course}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.email}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">
            <button onclick="showEditStudentModal('${s.id}')" style="background:#ffc107;color:#222;border:none;padding:0.3em 0.7em;border-radius:4px;cursor:pointer;">Edit</button>
            <button onclick="deleteStudent('${s.id}')" style="background:#dc3545;color:#fff;border:none;padding:0.3em 0.7em;border-radius:4px;cursor:pointer;margin-left:0.3em;">Delete</button>
          </td>
        </tr>
      `).join('');

      // Pagination controls
      let paginationHtml = '';
      if (totalPages > 1) {
        paginationHtml += `<button onclick="changeStudentPage(${studentCurrentPage - 1})" ${studentCurrentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
        for (let i = 1; i <= totalPages; i++) {
          paginationHtml += `<button onclick="changeStudentPage(${i})" ${i === studentCurrentPage ? 'style="font-weight:bold;background:#2d5be3;color:#fff;"' : ''}>${i}</button>`;
        }
        paginationHtml += `<button onclick="changeStudentPage(${studentCurrentPage + 1})" ${studentCurrentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
      }
      document.getElementById('studentPagination').innerHTML = paginationHtml;
    }




function showEditStudentModal(id) {
  const s = allStudents.find(stu => String(stu.id) === String(id));
  if (!s) return;
  document.getElementById('edit_id').value = s.id;
  document.getElementById('edit_rfid_number').value = s.rfid_number || '';
  document.getElementById('edit_id_number').value = s.id_number || '';
  document.getElementById('edit_lastname').value = s.lastname || '';
  document.getElementById('edit_firstname').value = s.firstname || '';
  document.getElementById('edit_middle_initial').value = s.middle_initial || '';
  document.getElementById('edit_course').value = s.course || '';
  document.getElementById('edit_email').value = s.email || '';
  document.getElementById('editStudentModal').style.display = 'flex';
}
window.showEditStudentModal = showEditStudentModal;





    function changeStudentPage(page) {
      const totalPages = Math.ceil(allStudents.length / studentRowsPerPage);
      if (page < 1 || page > totalPages) return;
      studentCurrentPage = page;
      renderStudentTable(allStudents);
    }
    window.changeStudentPage = changeStudentPage;

    // Tab switching logic
    const tabs = document.querySelectorAll('.tab');
    const contents = {
      'tab-subject': document.getElementById('content-subject'),
      'tab-student': document.getElementById('content-student'),
      'tab-upload': document.getElementById('content-upload'),
      'tab-report': document.getElementById('content-report') // NEW
    };
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        Object.values(contents).forEach(c => c.style.display = 'none');
        contents[tab.id].style.display = '';

        // Always close both modals when switching tabs
        document.getElementById('editSubjectModal').style.display = 'none';
        document.getElementById('editStudentModal').style.display = 'none';
      });
    });

    // Subject registration
    document.getElementById('subjectForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      const res = await fetch('http://localhost:3000/api/subjects/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      document.getElementById('subjectMessage').textContent = await res.text();
      e.target.reset();
      await loadSubjects(); // <-- reload subjects after adding
    });

    // Student registration
    document.getElementById('studentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      const res = await fetch('http://localhost:3000/api/students/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      document.getElementById('studentMessage').textContent = await res.text();
      e.target.reset();
      // Immediately reload the students table after registration
      await loadStudents();
    });

    // CSV upload
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault(); // Prevents page reload
      const fileInput = document.getElementById('csvFile');
      if (!fileInput.files.length) return false;

      const formData = new FormData();
      formData.append('csv', fileInput.files[0]);

      const response = await fetch('http://localhost:3000/api/students/upload', {
        method: 'POST',
        body: formData
      });

      const text = await response.text();
      document.getElementById('uploadMessage').textContent = text;
      e.target.reset();
      return false; // Extra safeguard
    });

    // REPORT TAB LOGIC
    // Load subjects for report dropdown
    async function loadReportSubjects() {
      const res = await fetch('http://localhost:3000/api/subjects');
      const subjects = await res.json();
      const select = document.getElementById('reportSubject');
      select.innerHTML = '<option value="">-- Select Subject --</option>';
      subjects.forEach(subj => {
        const opt = document.createElement('option');
        opt.value = subj.id;
        opt.textContent = `${subj.subject_code} - ${subj.subject_description}`;
        select.appendChild(opt);
      });
    }
    // Load subjects when report tab is clicked
    document.getElementById('tab-report').addEventListener('click', loadReportSubjects);

    // Handle report form submit
    document.getElementById('reportForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const subjectId = document.getElementById('reportSubject').value;
      const date = document.getElementById('reportDate').value;
      if (!subjectId || !date) return;

      // Get the selected subject's text
      const subjectText = document.getElementById('reportSubject').selectedOptions[0].textContent;

      // Set the labels
      document.getElementById('reportSubjectLabel').textContent = `Subject: ${subjectText}`;
      document.getElementById('reportDateLabel').textContent = `Date: ${date}`;

      const res = await fetch(`http://localhost:3000/api/attendance/report?subject_id=${subjectId}&date=${date}`);
      const data = await res.json();

      reportData = data;
      filteredReportData = data;
      currentPage = 1;
      sortColumn = null;
      sortDirection = 'asc';
      renderReportTable(filteredReportData);
      document.getElementById('reportPreview').style.display = 'block';
    });

    function renderReportTable(data = filteredReportData, printAll = false) {
      // Sort data
      if (sortColumn) {
        data = [...data].sort((a, b) => {
          let valA = a[sortColumn] || '';
          let valB = b[sortColumn] || '';
          if (typeof valA === 'string') valA = valA.toLowerCase();
          if (typeof valB === 'string') valB = valB.toLowerCase();
          if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
          if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
          return 0;
        });
      }

      // Pagination
      const totalRows = data.length;
      const totalPages = Math.ceil(totalRows / rowsPerPage);
      const startIdx = (currentPage - 1) * rowsPerPage;
      const pageData = printAll ? data : data.slice(startIdx, startIdx + rowsPerPage);

      // Table headers with sort icons
      const headers = [
        { key: null, label: 'No.' },
        { key: 'lastname', label: 'Student Name' },
        { key: 'id_number', label: 'Student Number' },
        { key: 'course', label: 'Course' }, // <-- Add this line
        { key: 'time_in', label: 'Time In' },
        { key: 'time_out', label: 'Time Out' }
      ];

      let html = `<table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="background:#f4f6fb;">` +
            headers.map(h => {
              if (!h.key) return `<th style="border:1px solid #d1d9e6;padding:0.5em;">${h.label}</th>`;
              const icon = sortColumn === h.key
                ? (sortDirection === 'asc'
                    ? ' <span style="font-size:1em;">&#9650;</span>'
                    : ' <span style="font-size:1em;">&#9660;</span>')
                : ' <span style="color:#ccc;font-size:1em;">&#9651;</span>';
              return `<th style="border:1px solid #d1d9e6;padding:0.5em;cursor:pointer;" onclick="sortReportTable('${h.key}')">${h.label}${icon}</th>`;
            }).join('') +
          `</tr>
        </thead>
        <tbody>
          ${pageData.length ? pageData.map((row, idx) => `
            <tr>
              <td style="border:1px solid #d1d9e6;padding:0.5em;text-align:center;">${startIdx + idx + 1}</td>
              <td style="border:1px solid #d1d9e6;padding:0.5em;">
                ${row.lastname}, ${row.firstname}${row.middle_initial ? ' ' + row.middle_initial + '.' : ''}
              </td>
              <td style="border:1px solid #d1d9e6;padding:0.5em;">${row.id_number}</td>
              <td style="border:1px solid #d1d9e6;padding:0.5em;">${row.course || '-'}</td> <!-- Course column -->
              <td style="border:1px solid #d1d9e6;padding:0.5em;">${row.time_in ? new Date(row.time_in).toLocaleString() : '-'}</td>
              <td style="border:1px solid #d1d9e6;padding:0.5em;">${row.time_out ? new Date(row.time_out).toLocaleString() : '-'}</td>
            </tr>
          `).join('') : `<tr><td colspan="6" style="text-align:center;padding:1em;">No records found.</td></tr>`}
        </tbody>
      </table>`;

      // Pagination controls
      if (!printAll) {
        html += `<div class="report-pagination" style="margin-top:1em;display:flex;justify-content:center;gap:0.5em;">`;
        for (let i = 1; i <= totalPages; i++) {
          html += `<button onclick="goToReportPage(${i})" style="padding:0.3em 0.8em;${i === currentPage ? 'background:#0d6efd;color:#fff;' : 'background:#eaf6ff;'}border:1px solid #b5d6f8;border-radius:4px;cursor:pointer;">${i}</button>`;
        }
        html += `</div>`;
      }

      document.getElementById('reportTableContainer').innerHTML = html;
    }

    function printReportSection() {
      // Prompt for course filter before printing
      const uniqueCourses = [...new Set(reportData.map(row => row.course).filter(Boolean))];
      let courseFilter = '';
      if (uniqueCourses.length > 1) {
        courseFilter = prompt(
          "Enter course name to print only that course (leave blank to print all):\n" +
          uniqueCourses.join(', ')
        );
        if (courseFilter !== null && courseFilter.trim() !== '') {
          // Filter reportData by course (case-insensitive)
          const filtered = reportData.filter(row =>
            row.course && row.course.toLowerCase().includes(courseFilter.trim().toLowerCase())
          );
          renderReportTable(filtered, true);
        } else {
          renderReportTable(reportData, true);
        }
      } else {
        renderReportTable(reportData, true);
      }
      const printContents = document.getElementById('reportPreview').innerHTML;
      document.body.innerHTML = printContents;
      window.print();
      location.reload();
    }

    function sortReportTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      currentPage = 1;
      renderReportTable(reportData);
    }

    function goToReportPage(page) {
      currentPage = page;
      renderReportTable(reportData);
    }

    let currentPage = 1;
    const rowsPerPage = 10;
    let sortColumn = null;
    let sortDirection = 'asc';
    let reportData = [];
    let filteredReportData = [];

    window.sortReportTable = sortReportTable;
    window.goToReportPage = goToReportPage;

    // Filter report table based on search input
    function filterReportTable() {
      const query = document.getElementById('reportSearch').value.trim().toLowerCase();
      if (!query) {
        filteredReportData = reportData;
      } else {
        filteredReportData = reportData.filter(row => {
          // Combine all searchable fields as string, now including firstname
          const fields = [
            row.lastname,
            row.firstname, // <-- include firstname
            row.id_number,
            row.course,
            row.time_in ? new Date(row.time_in).toLocaleString() : '',
            row.time_out ? new Date(row.time_out).toLocaleString() : ''
          ];
          return fields.some(field => field && field.toString().toLowerCase().includes(query));
        });
      }
      currentPage = 1;
      renderReportTable(filteredReportData);
    }

    // Make filterReportTable global for inline oninput
    window.filterReportTable = filterReportTable;


    function closeEditStudentModal() {
      document.getElementById('editStudentModal').style.display = 'none';
    }

    document.getElementById('editStudentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      const res = await fetch('http://localhost:3000/api/students/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      const msg = await res.text();
      document.getElementById('studentMessage').textContent = msg;

      // Only close the modal if update is successful
      if (msg.toLowerCase().includes('success')) {
        closeEditStudentModal();
        loadStudents();
      }
    });

    // Add this script section after your other JS code

    let allSubjects = [];
    let subjectCurrentPage = 1;
    const subjectRowsPerPage = 10;

    async function loadSubjects() {
      const res = await fetch('http://localhost:3000/api/subjects');
      allSubjects = await res.json();
      renderSubjectTable(allSubjects);
    }

    // Render subjects with pagination
    function renderSubjectTable(data) {
      const tbody = document.getElementById('subjectTableBody');
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:1em;">No subjects found.</td></tr>`;
        document.getElementById('subjectPagination').innerHTML = '';
        return;
      }
      const totalRows = data.length;
      const totalPages = Math.ceil(totalRows / subjectRowsPerPage);
      if (subjectCurrentPage > totalPages) subjectCurrentPage = totalPages || 1;
      const startIdx = (subjectCurrentPage - 1) * subjectRowsPerPage;
      const pageData = data.slice(startIdx, startIdx + subjectRowsPerPage);

      tbody.innerHTML = pageData.map((s, idx) => `
        <tr>
          <td style="border:1px solid #d1d9e6;padding:0.5em;text-align:center;">${startIdx + idx + 1}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.subject_code}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">${s.subject_description}</td>
          <td style="border:1px solid #d1d9e6;padding:0.5em;">
            <button onclick="showEditSubjectModal('${s.id}')" style="background:#ffc107;color:#222;border:none;padding:0.3em 0.7em;border-radius:4px;cursor:pointer;">Edit</button>
            <button onclick="deleteSubject('${s.id}')" style="background:#dc3545;color:#fff;border:none;padding:0.3em 0.7em;border-radius:4px;cursor:pointer;margin-left:0.3em;">Delete</button>
          </td>
        </tr>
      `).join('');

      // Pagination controls
      let paginationHtml = '';
      if (totalPages > 1) {
        paginationHtml += `<button onclick="changeSubjectPage(${subjectCurrentPage - 1})" ${subjectCurrentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
        for (let i = 1; i <= totalPages; i++) {
          paginationHtml += `<button onclick="changeSubjectPage(${i})" ${i === subjectCurrentPage ? 'style="font-weight:bold;background:#2d5be3;color:#fff;"' : ''}>${i}</button>`;
        }
        paginationHtml += `<button onclick="changeSubjectPage(${subjectCurrentPage + 1})" ${subjectCurrentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
      }
      document.getElementById('subjectPagination').innerHTML = paginationHtml;
    }

    function changeSubjectPage(page) {
      const totalPages = Math.ceil(allSubjects.length / subjectRowsPerPage);
      if (page < 1 || page > totalPages) return;
      subjectCurrentPage = page;
      renderSubjectTable(allSubjects);
    }
    window.changeSubjectPage = changeSubjectPage;

    // Search/filter subjects
    function filterSubjectTable() {
      const query = document.getElementById('subjectSearch').value.trim().toLowerCase();
      const filtered = allSubjects.filter(s =>
        (s.subject_code && s.subject_code.toLowerCase().includes(query)) ||
        (s.subject_description && s.subject_description.toLowerCase().includes(query))
      );
      subjectCurrentPage = 1;
      renderSubjectTable(filtered);
    }
    window.filterSubjectTable = filterSubjectTable;

    // Edit modal logic
    function showEditSubjectModal(id) {
      const s = allSubjects.find(subj => String(subj.id) === String(id));
      if (!s) return;
      document.getElementById('edit_subject_id').value = s.id;
      document.getElementById('edit_subject_code').value = s.subject_code;
      document.getElementById('edit_subject_description').value = s.subject_description;
      document.getElementById('editSubjectModal').style.display = 'flex';
    }
    window.showEditSubjectModal = showEditSubjectModal;

    function closeEditSubjectModal() {
      document.getElementById('editSubjectModal').style.display = 'none';
    }
    window.closeEditSubjectModal = closeEditSubjectModal;

    document.getElementById('editSubjectForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      const res = await fetch('http://localhost:3000/api/subjects/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      const msg = await res.text();
      document.getElementById('subjectMessage').textContent = msg;
      closeEditSubjectModal();
      loadSubjects();
    });

    // Delete subject
    async function deleteSubject(id) {
      if (!confirm('Are you sure you want to delete this subject?')) return;
      const res = await fetch(`http://localhost:3000/api/subjects/delete/${id}`, { method: 'DELETE' });
      const msg = await res.text();
      document.getElementById('subjectMessage').textContent = msg;
      loadSubjects();
    }
    window.deleteSubject = deleteSubject;

    // Load subjects on tab click
    document.getElementById('tab-subject').addEventListener('click', loadSubjects);

    // Also reload after registering a subject
    document.getElementById('subjectForm').addEventListener('submit', async function() {
      setTimeout(loadSubjects, 200); // slight delay to ensure DB update
    });

    document.getElementById('tab-student').addEventListener('click', loadStudents);
  </script>

  <script>
    // Add to your script section
    async function deleteStudent(id) {
      if (!confirm('Are you sure you want to delete this student?')) return;
      const res = await fetch(`http://localhost:3000/api/students/delete/${id}`, { method: 'DELETE' });
      const msg = await res.text();
      document.getElementById('studentMessage').textContent = msg;
      loadStudents();
    }
    window.deleteStudent = deleteStudent;

    function filterStudentTable() {
      const query = document.getElementById('studentSearch').value.trim().toLowerCase();
      if (!query) {
        renderStudentTable(allStudents);
        return;
      }
      const filtered = allStudents.filter(s =>
        (s.lastname && s.lastname.toLowerCase().includes(query)) ||
        (s.firstname && s.firstname.toLowerCase().includes(query)) ||
        (s.id_number && s.id_number.toLowerCase().includes(query)) ||
        (s.course && s.course.toLowerCase().includes(query))
      );
      studentCurrentPage = 1;
      renderStudentTable(filtered);
    }
    window.filterStudentTable = filterStudentTable;
  </script>

</body>
</html>